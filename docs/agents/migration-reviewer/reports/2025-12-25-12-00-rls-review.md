# Migration Review Report - 2025-12-25

## Executive Summary

**Review Type:** Row Level Security (RLS) Implementation
**Total Migrations:** 10 migrations + 1 schema change
**Risk Level:** MEDIUM (Safe after consolidation)
**Recommendation:** CONSOLIDATE before production deployment

---

## Context

### Migrations Reviewed

1. `20251225102653_add_rls` - Initial RLS setup
2. `20251225103500_fix_rls_function` - UUID/TEXT type fix
3. `20251225104500_add_system_bypass` - SYSTEM context bypass
4. `20251225105000_fix_insert_policies` - Split INSERT/SELECT policies
5. `20251225110000_fix_insert_check` - Direct current_setting
6. `20251225110500_fix_workspace_insert` - Allow authenticated inserts
7. `20251225111000_disable_insert_rls` - Disable INSERT RLS (WITH CHECK true)
8. `20251225120000_add_created_by_to_workspace` - Add createdById column
9. `20251225130000_add_tenant_user_lookup` - Add TenantUserEmailLookup table
10. `20251225140000_fix_workspace_rls` - Final RLS fix with createdById

### Schema Changes

- Added `Workspace.createdById` (TEXT NOT NULL, FK to User.id)
- Added `TenantUserEmailLookup` table (for SPEC-020)
- Added relation `User.createdWorkspaces`

### Architecture Context

According to SPEC-001:
- RLS provides database-level workspace isolation
- Uses `app.current_user_id` session variable
- Non-superuser DB role (`knowledge_forge_app`) enforces RLS
- SYSTEM context for bypassing RLS in migrations/tests

---

## Critical Issues

### CRITICAL - UTRATA DANYCH

**NONE** - No data loss operations detected.

---

## HIGH - Ryzyko Breaking Change

### HIGH-1: TenantUserEmailLookup bez RLS policies

**Problem:** New table `TenantUserEmailLookup` created without RLS policies.

**Risk:**
- Users can potentially see email hashes from other workspaces
- Breaks workspace isolation guarantee
- Security vulnerability for SPEC-020 implementation

**How to fix:**
```sql
-- Enable RLS on TenantUserEmailLookup
ALTER TABLE "TenantUserEmailLookup" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "TenantUserEmailLookup" FORCE ROW LEVEL SECURITY;

-- SELECT: see only entries from your workspaces
CREATE POLICY tenant_lookup_select ON "TenantUserEmailLookup"
  FOR SELECT
  TO PUBLIC
  USING ("workspaceId" IN (SELECT * FROM get_user_workspace_ids()));

-- INSERT: can only insert into your workspaces
CREATE POLICY tenant_lookup_insert ON "TenantUserEmailLookup"
  FOR INSERT
  TO PUBLIC
  WITH CHECK ("workspaceId" IN (SELECT * FROM get_user_workspace_ids()));

-- UPDATE: can only update entries from your workspaces
CREATE POLICY tenant_lookup_update ON "TenantUserEmailLookup"
  FOR UPDATE
  TO PUBLIC
  USING ("workspaceId" IN (SELECT * FROM get_user_workspace_ids()))
  WITH CHECK ("workspaceId" IN (SELECT * FROM get_user_workspace_ids()));

-- DELETE: can only delete entries from your workspaces
CREATE POLICY tenant_lookup_delete ON "TenantUserEmailLookup"
  FOR DELETE
  TO PUBLIC
  USING ("workspaceId" IN (SELECT * FROM get_user_workspace_ids()));
```

---

## MEDIUM - Wymaga Uwagi

### MEDIUM-1: Migration consolidation needed

**Problem:** 10 migrations for a single feature (RLS). This is a sign of iterative development/debugging.

**Risk:**
- Hard to review and understand the final state
- Potential for orphaned/conflicting policies
- Production deployment complexity

**Recommendation:** Consolidate into 2-3 migrations:
1. `20251225_add_rls_base` - Initial RLS setup + helper functions
2. `20251225_add_workspace_created_by` - Schema change (createdById)
3. `20251225_add_tenant_lookup` - TenantUserEmailLookup table + RLS

**How to consolidate (BEFORE production deploy):**
```bash
# 1. Reset migrations (DEV ONLY)
npx prisma migrate reset

# 2. Delete old migration folders
rm -rf apps/api/prisma/migrations/20251225*

# 3. Create consolidated migration
npx prisma migrate dev --name add_rls_workspace_isolation

# 4. Test thoroughly
npm run test:rls
```

### MEDIUM-2: INSERT policies inconsistency

**Problem:** Migrations 5-7 show struggle with INSERT policies:
- Migration 5: `is_system_context()` function
- Migration 6: `current_setting` direct check
- Migration 7: Disabled INSERT RLS (`WITH CHECK true`)

**Current state (Migration 10):**
- Workspace INSERT: `WITH CHECK ("createdById" = get_current_user_id())` - CORRECT
- Other tables INSERT: `WITH CHECK (true)` - PERMISSIVE

**Risk:**
- Permissive INSERT policies on Document, Chunk, etc. rely on application-level validation
- Not true defense-in-depth (RLS should protect even if app code fails)

**Recommendation:**
Keep current implementation FOR NOW (app-level validation is sufficient for MVP), but add to backlog:
```markdown
TODO: Tighten INSERT policies for Document, Chunk, PublicLink
- Document: WITH CHECK ("workspaceId" IN (SELECT * FROM get_user_workspace_ids()))
- Chunk: WITH CHECK ("documentId" IN (SELECT d.id FROM "Document" d WHERE d."workspaceId" IN (...)))
- etc.
```

### MEDIUM-3: Schema change with backfill (ADD COLUMN NOT NULL)

**Operation:** Migration 8 adds `Workspace.createdById` NOT NULL

**Risk:** Medium - handled correctly with backfill strategy

**Mitigation applied:**
1. Add column as nullable
2. Backfill from WorkspaceMember (OWNER role)
3. Backfill from first member if no owner
4. Backfill from any user if no members
5. Set NOT NULL constraint
6. Add FK constraint

**Verification needed:**
```sql
-- Check no NULLs before production deploy
SELECT COUNT(*) FROM "Workspace" WHERE "createdById" IS NULL;
-- Should be 0
```

---

## LOW - Sugestie

### LOW-1: Funkcja get_user_workspace_ids() marked STABLE

**Issue:** Function is `STABLE` but queries `WorkspaceMember` which can change during transaction.

**Impact:** Low - in practice, workspace membership doesn't change mid-request.

**Suggestion:** Consider `VOLATILE` for strict correctness:
```sql
CREATE OR REPLACE FUNCTION get_user_workspace_ids()
RETURNS SETOF TEXT AS $$
...
$$ LANGUAGE plpgsql SECURITY DEFINER VOLATILE;  -- Changed from STABLE
```

### LOW-2: GRANT EXECUTE TO PUBLIC

**Issue:** Helper functions granted to PUBLIC.

**Impact:** Low - functions respect RLS via SECURITY DEFINER.

**Suggestion:** Restrict to specific role:
```sql
GRANT EXECUTE ON FUNCTION get_user_workspace_ids() TO knowledge_forge_app;
GRANT EXECUTE ON FUNCTION get_current_user_id() TO knowledge_forge_app;
```

### LOW-3: Missing RLS on Tag table

**Status:** Tag table has no RLS policies (intentionally global per SPEC-001).

**Verification:** Confirmed in spec:
> Tabela Tag - globalna (tagi są współdzielone między workspace'ami)

**Action:** NONE - working as designed.

---

## Bezpieczne operacje

1. `ENABLE ROW LEVEL SECURITY` - Safe
2. `FORCE ROW LEVEL SECURITY` - Safe (enforces RLS for superuser)
3. `CREATE FUNCTION` (SECURITY DEFINER) - Safe
4. `CREATE POLICY` - Safe
5. `DROP POLICY IF EXISTS` - Safe (idempotent)
6. `ALTER TABLE ADD COLUMN` - Safe (with backfill strategy)
7. `CREATE INDEX` - Safe
8. `ADD CONSTRAINT FOREIGN KEY` - Safe (data validated before constraint)

---

## Zgodność ze standardami

### Timestampy

**Check:** All timestamps as `timestamp with time zone`

```
TenantUserEmailLookup.createdAt: TIMESTAMPTZ ✅
TenantUserEmailLookup.updatedAt: TIMESTAMPTZ ✅
```

**Status:** PASS

### Nazewnictwo

**Check:** snake_case for tables, camelCase for Prisma fields

**Status:** PASS
- Table: `TenantUserEmailLookup` (PascalCase in Prisma, correct)
- Column: `createdById` (camelCase in Prisma, correct)

### Multi-tenancy

**Architecture:** Database per Tenant (from ecosystem.md - NOT FOUND, assumed from CLAUDE.md)

**Wait - Critical question:** Project uses multi-tenancy model, but which one?
- SPEC-001 implements RLS for workspace isolation WITHIN single database
- This suggests **single database, multi-schema** or **single database, RLS-based isolation**

**Verification:** RLS policies use `get_user_workspace_ids()` - this is **NOT** database-per-tenant.

**Conclusion:** Knowledge Forge uses **RLS-based multi-tenancy** (all tenants in one DB, isolated by RLS).

**Status:** PASS - migrations compatible with single-DB multi-tenancy.

---

## Performance Check

### Indices

**Check:** All RLS-critical columns indexed?

```
Workspace.createdById: INDEXED ✅ (Migration 8)
WorkspaceMember.workspaceId: INDEXED ✅ (schema.prisma @@index)
WorkspaceMember.userId: INDEXED ✅ (schema.prisma @@index)
Document.workspaceId: INDEXED ✅ (schema.prisma @@index)
TenantUserEmailLookup.emailHash: INDEXED ✅ (Migration 9)
TenantUserEmailLookup.workspaceId: IMPLIED via FK ✅
```

**Status:** PASS

### RLS Function Performance

**Concern:** `get_user_workspace_ids()` called on every SELECT.

**Mitigation:**
- Function marked STABLE (can be cached within query)
- WorkspaceMember table has proper indices
- Typical user has 1-5 workspaces (small result set)

**Recommendation:** Monitor query performance in production. Add materialized cache if needed.

---

## Rollback Plan

### Can migrations be rolled back?

**Answer:** PARTIALLY - Prisma doesn't generate down migrations.

**Manual rollback SQL required:**

```sql
-- Rollback Migration 10
DROP POLICY IF EXISTS workspace_select ON "Workspace";
DROP POLICY IF EXISTS workspace_insert ON "Workspace";
DROP POLICY IF EXISTS workspace_update ON "Workspace";
DROP POLICY IF EXISTS workspace_delete ON "Workspace";
DROP FUNCTION IF EXISTS get_current_user_id();
-- Restore Migration 8 policies...

-- Rollback Migration 9
DROP TABLE "TenantUserEmailLookup";

-- Rollback Migration 8
ALTER TABLE "Workspace" DROP CONSTRAINT "Workspace_createdById_fkey";
ALTER TABLE "Workspace" DROP COLUMN "createdById";
-- Restore Migration 7 policies...

-- Rollback Migrations 1-7
-- Drop all RLS policies
-- Disable RLS on tables
-- Drop helper functions
```

**Recommendation:** Create explicit rollback scripts:
```bash
docs/migrations/rollback/20251225_rls_rollback.sql
```

---

## Checklist przed deploy

- [ ] **Backup bazy wykonany** - CRITICAL
- [ ] **Migracja przetestowana na staging** - Required
- [x] **RLS testy przechodzą (26/26)** - PASSING (per SPEC-001)
- [ ] **TenantUserEmailLookup RLS policies dodane** - REQUIRED (HIGH-1)
- [ ] **Consolidacja migracji (opcjonalnie)** - RECOMMENDED
- [ ] **Non-superuser role (`knowledge_forge_app`) skonfigurowany** - Required
- [ ] **Rollback plan przygotowany** - RECOMMENDED
- [ ] **Maintenance window (jeśli potrzebny)** - NOT NEEDED (small tables)
- [ ] **Performance baseline zapisany** - RECOMMENDED

---

## Wymagane akcje przed migracją

### MUST (Blokują deploy)

1. **Add RLS policies for TenantUserEmailLookup** (HIGH-1)
   ```bash
   npx prisma migrate dev --name add_tenant_lookup_rls --create-only
   # Edit migration.sql with policies from HIGH-1
   npx prisma migrate deploy
   ```

2. **Verify createdById backfill**
   ```sql
   SELECT COUNT(*) FROM "Workspace" WHERE "createdById" IS NULL;
   -- Must be 0
   ```

3. **Test na staging z RLS enforced**
   ```bash
   # Use non-superuser role
   DATABASE_URL="postgresql://knowledge_forge_app:...@staging/knowledge_forge"
   npm run test:rls
   ```

### SHOULD (Mocno rekomendowane)

4. **Consolidate migrations** (przed production deploy)
   - Reduces complexity
   - Easier rollback
   - Cleaner git history

5. **Create rollback script**
   ```bash
   docs/migrations/rollback/20251225_rls_rollback.sql
   ```

6. **Performance baseline**
   ```bash
   # Before RLS
   EXPLAIN ANALYZE SELECT * FROM "Document" WHERE "workspaceId" = '...';
   # After RLS (with SET LOCAL app.current_user_id)
   ```

### COULD (Nice to have)

7. **Tighten INSERT policies** (future task)
   - Document, Chunk, PublicLink, etc.
   - Currently rely on app-level validation (acceptable for MVP)

8. **Change function STABLE -> VOLATILE** (LOW-1)

9. **Restrict GRANT EXECUTE** (LOW-2)

---

## Migration Safety Summary

| Operacja | Count | Safe? | Notes |
|----------|-------|-------|-------|
| `ENABLE ROW LEVEL SECURITY` | 6 | ✅ Yes | No data changes |
| `FORCE ROW LEVEL SECURITY` | 6 | ✅ Yes | Enforces RLS for superuser |
| `CREATE FUNCTION` | 3 | ✅ Yes | SECURITY DEFINER, STABLE |
| `CREATE POLICY` | ~30 | ✅ Yes | Multiple iterations |
| `DROP POLICY` | ~30 | ✅ Yes | Idempotent (IF EXISTS) |
| `ALTER TABLE ADD COLUMN` | 1 | ✅ Yes | With backfill strategy |
| `ALTER TABLE ALTER COLUMN SET NOT NULL` | 1 | ✅ Yes | After backfill |
| `ADD CONSTRAINT FK` | 2 | ✅ Yes | After data validation |
| `CREATE INDEX` | 2 | ✅ Yes | Non-blocking |
| `CREATE TABLE` | 1 | ✅ Yes | TenantUserEmailLookup |

**Overall:** SAFE with required actions completed.

---

## Test Results Verification

Per SPEC-001 Section 9:
```
Test Results: 26/26 PASSING
- 8 test suites covering all RLS scenarios
- Workspace, Document, Chunk, WorkspaceMember, PublicLink isolation
- ID manipulation blocking
- Stress tests (50+ parallel operations)
- Context switching tests
```

**Status:** ✅ PASSING

**Recommendation:** Add test for TenantUserEmailLookup isolation after HIGH-1 fix.

---

## Final Recommendation

### Deploy Decision: CONDITIONAL APPROVE

**Conditions:**
1. MUST fix HIGH-1 (TenantUserEmailLookup RLS policies)
2. SHOULD consolidate migrations (before production)
3. MUST test on staging with non-superuser role
4. MUST verify createdById backfill (no NULLs)

**After conditions met:** SAFE TO DEPLOY

**Estimated effort to fix:**
- HIGH-1: 30 minutes (write migration, test)
- Consolidation: 2 hours (optional but recommended)
- Staging test: 1 hour
- **Total: 1-3.5 hours**

---

## Appendix: Migration Sequence Analysis

### Evolution of INSERT policies (Migrations 5-10)

1. **Migration 5:** Introduced `is_system_context()` function + split policies
   - Problem: Function evaluated in wrong context

2. **Migration 6:** Direct `current_setting` check
   - Problem: Still chicken-and-egg for Workspace INSERT

3. **Migration 7:** Disabled INSERT RLS (`WITH CHECK true`)
   - Problem: Security hole, but unblocked development

4. **Migration 8:** Added `createdById` column to Workspace
   - Key insight: Need column for direct comparison

5. **Migration 10:** Final fix using `createdById = get_current_user_id()`
   - Solution: Direct column comparison (core-platform pattern)

### Key Learnings (per SPEC-001)

1. PostgreSQL superuser always bypasses RLS - use non-superuser for production ✅
2. For INSERT policies, use direct column comparison not subquery ✅
3. Subquery-based policies have chicken-and-egg problem for INSERT ✅
4. Prisma ORM interactive transactions work correctly with `set_config()` ✅
5. Follow core-platform pattern: one policy per operation type ✅

**Conclusion:** Final implementation (Migration 10) is correct and follows best practices.

---

## Document Metadata

- **Reviewer:** Migration Reviewer Agent
- **Review Date:** 2025-12-25 12:00
- **Specification:** SPEC-001 Row Level Security
- **Migrations:** 20251225102653 through 20251225140000 (10 total)
- **Schema Changes:** Workspace.createdById, TenantUserEmailLookup table
- **Test Status:** 26/26 PASSING
- **Risk Level:** MEDIUM (HIGH after TenantUserEmailLookup RLS fix)
- **Recommendation:** CONDITIONAL APPROVE (fix HIGH-1 first)

---

## References

- `/Users/michalkukla/development/knowledge-forge/docs/specifications/SPEC-001-row-level-security.md`
- `/Users/michalkukla/development/knowledge-forge/CLAUDE.md`
- `/Users/michalkukla/development/knowledge-forge/apps/api/prisma/schema.prisma`
- `/Users/michalkukla/development/knowledge-forge/apps/api/prisma/migrations/20251225*`
